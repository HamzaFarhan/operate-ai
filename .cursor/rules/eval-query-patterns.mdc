---
description:
globs:
alwaysApply: false
---
# Evaluation Query Patterns & Templates

## Common Query Types

### 1. Customer Cohort Identification
Template for queries that identify a specific group of customers:

```python
"""Count the total number of unique customers who [SPECIFIC_CRITERIA].

A customer is considered [CRITERIA_NAME] if:
- [CONDITION_1] AND
- [CONDITION_2] OR [ALTERNATIVE_CONDITION]

Return only the count as an integer."""
```

Example: Active customers in a time period (see [step1_evals.py](mdc:evals/scenario1/step1_evals.py))

### 2. Segmentation Analysis
Template for breaking down customers by attributes:

```python
"""For customers who [COHORT_DEFINITION], provide a breakdown by their [SEGMENT_TYPE].

Step-by-step logic:
1. Identify all customers who [COHORT_CRITERIA] (using the same definition as above)
2. For each customer, find their [SPECIFIC_FIELD_OR_CALCULATION]
3. Use [SPECIFIC_TABLE_FIELD] to categorize them as [LIST_EXACT_CATEGORIES]
4. Count how many customers fall into each category

Return the counts as: {[EXACT_JSON_FORMAT]} where values are integers representing customer counts."""
```

### 3. Financial Metrics (ARPU, LTV, etc.)
Template for revenue/profit calculations:

```python
"""Calculate the [METRIC_NAME] for customers who [COHORT_DEFINITION], broken down by [SEGMENT_TYPE].

Calculation Method:
- Use [SPECIFIC_DATA_SOURCE] from [DATE_RANGE] 
- Formula: [EXACT_FORMULA]
- Apply [SPECIFIC_ASSUMPTIONS] if needed

Return as: {[EXACT_OUTPUT_FORMAT]} where values are floats rounded to 2 decimal places."""
```

### 4. Rate Calculations (Churn, Retention, etc.)
Template for percentage-based metrics:

```python
"""Calculate the [RATE_TYPE] for customers who [COHORT_DEFINITION].

Definition of [RATE_EVENT]:
- [SPECIFIC_CONDITIONS_FOR_EVENT]
- Time period: [EXACT_DATE_RANGE]
- Status criteria: [SPECIFIC_STATUS_FIELDS]

If any segment shows 0% [RATE], assume [FALLBACK_ASSUMPTION].

Return as: {[OUTPUT_FORMAT]} where values are floats (0.0-1.0 representing percentages)."""
```

## Field References

### Always Specify Exact Fields
❌ Bad: "subscription type"
✅ Good: "SubscriptionType field from the subscriptions table"

❌ Bad: "plan"  
✅ Good: "PlanName field from their first subscription"

### Table References
Always clarify which table contains the field:
- `customers.IndustrySegment` 
- `subscriptions.StartDate`
- `orders.Profit`

## Output Format Specifications

### Simple Counts
```
Return only the count as an integer.
```

### Structured Data
```
Return the counts as: {"basic": X, "pro": Y, "enterprise": Z} where X, Y, Z are integers representing customer counts.
```

### Financial Data
```
Return as: {"monthly": X.XX, "annual": Y.YY} where values are floats rounded to 2 decimal places.
```

## Date Range Patterns

### Specific Periods
```
during January 2023 (January 1-31, 2023)
from July 2024 to Dec 2024 (July 1 - December 31, 2024)
```

### Ongoing/Active Criteria
```
A subscription is considered active during [PERIOD] if:
- The subscription StartDate is on or before [END_DATE] AND  
- The subscription EndDate is on or after [START_DATE] OR the subscription has no EndDate (null/NaT, meaning it's still ongoing)
```

## Cross-Reference Patterns
When building on previous queries:
```
For customers who [REFERENCE_TO_PREVIOUS_CRITERIA] (using the same active definition as above)
```

## Application
Apply these patterns to:
- All QUERIES dictionaries in eval files
- New evaluation queries
- Documentation and comments
- CSV generation functions

Reference: [eval-query-clarity.mdc](mdc:.cursor/rules/eval-query-clarity.mdc) for the underlying principles.
